---
import ThemeToggle from "./ThemeToggle.astro";

// import ThemeToggle from "./ThemeToggle.astro"

const navItems = [
   // {
   //    title: "Inicio",
   //    label: "Inicio",
   //    url: "/#top",
   // },
   // {
   //    title: "Experiencia",
   //    label: "experiencia",
   //    url: "/#experiencia",
   // },

   {
      title: "Proyectos",
      label: "proyectos",
      url: "/#proyectos",
   },
   {
      title: "Sobre m√≠",
      label: "sobre-mi",
      url: "/#sobre-mi",
   },
   {
      title: "Formaci√≥n",
      label: "formaci√≥n",
      url: "/#formacion",
   },
   {
      title: "Contacto",
      label: "contacto",
      url: "mailto:santiago.goncalvez.l@gmail.com",
   },
];
---

<header
   class="fixed top-0 z-10 flex items-center justify-center w-full mx-auto mt-2"
>
   <nav
      class="flex px-2 p-1 md:gap-2 gap-1 font-medium rounded-lg text-bg-deep dark:text-title justify-center items-center"
   >
      {
         navItems.map((link) => (
            <a
               class="relative block px-2 transition rounded-lg p-1 hover:text-title hover:bg-border-strong dark:hover:bg-title dark:hover:text-bg-elevated text-xs md:text-sm "
               aria-label={link.label}
               href={link.url}
            >
               {link.title}
            </a>
         ))
      }
      <!-- <ThemeToggle /> -->
      <ThemeToggle />
   </nav>
</header>

<script>
   const removeAccents = (str = "") => {
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
   };

   document.addEventListener("astro:page-load", () => {
      const sections = document.querySelectorAll("section");
      const navItems = document.querySelectorAll("header nav a");
      const root = document.documentElement;

      const isDark = () => root.classList.contains("dark");

      let activeItem = null;

      const applyStyles = (item) => {
         if (!item) return;

         // Limpieza total
         item.classList.remove(
            "bg-title",
            "text-bg-elevated",
            "bg-bg-surface",
            "text-title"
         );

         if (isDark()) {
            // üåô DARK
            item.classList.add("bg-title", "text-bg-elevated");
         } else {
            // ‚òÄÔ∏è LIGHT
            item.classList.add("bg-bg-surface", "text-title");
         }
      };

      const clearStyles = (item) => {
         item.classList.remove(
            "bg-title",
            "text-bg-elevated",
            "bg-bg-surface",
            "text-title"
         );
      };

      // üß≠ Intersection Observer
      const callback = (entries) => {
         entries.forEach((entry) => {
            if (!entry.isIntersecting) return;

            navItems.forEach((item) => {
               const isActive =
                  removeAccents(item.getAttribute("aria-label") || "") ===
                  entry.target.id;

               if (isActive) {
                  if (activeItem && activeItem !== item) {
                     clearStyles(activeItem);
                  }

                  activeItem = item;
                  applyStyles(activeItem);
               }
            });
         });
      };

      const observer = new IntersectionObserver(callback, {
         root: null,
         rootMargin: "0px",
         threshold: 0.3,
      });

      sections.forEach((section) => observer.observe(section));

      // üåó Mutation Observer ‚Üí detectar cambio dark/light
      const themeObserver = new MutationObserver((mutations) => {
         mutations.forEach((mutation) => {
            if (
               mutation.type === "attributes" &&
               mutation.attributeName === "class"
            ) {
               applyStyles(activeItem);
            }
         });
      });

      themeObserver.observe(root, {
         attributes: true,
         attributeFilter: ["class"],
      });

      // üßπ Cleanup visibilidad
      document.onvisibilitychange = () => {
         if (document.visibilityState === "hidden") {
            observer.disconnect();
         } else {
            sections.forEach((section) => observer.observe(section));
         }
      };
   });
</script>

<style>
   @reference "../styles/global.css";

   /* 1. Definimos las variables base (Light Mode) */
   nav {
      --nav-bg: rgba(255, 255, 255, 0.8);
      --nav-border: rgba(0, 0, 0, 0.08);
      --nav-shadow: rgba(0, 0, 0, 0.05);

      animation: nav-shadown 1s linear both;
      animation-timeline: scroll();
      animation-range: 0 100px;
   }

   /* 2. Sobrescribimos las variables para Dark Mode */
   /* Usamos :global(.dark) para asegurar que detecte la clase en el HTML */
   :global(.dark) nav {
      --nav-bg: rgba(18, 18, 18, 0.8); /* Tu color #121212 m√°s oscuro */
      --nav-border: rgba(255, 255, 255, 0.1);
      --nav-shadow: rgba(0, 0, 0, 0.5);
   }

   @keyframes nav-shadown {
      0% {
         background-color: transparent;
         border: 1px solid transparent;
         box-shadow: 0 0 0 transparent;
      }
      to {
         background-color: var(--nav-bg);
         backdrop-filter: blur(12px);
         border: 1px solid var(--nav-border);
         box-shadow: 0 10px 15px -3px var(--nav-shadow);
      }
   }
</style>
