---
import ThemeToggle from "./ThemeToggle.astro";

const navItems = [
   { title: "Proyectos", label: "proyectos", url: "/#proyectos" },
   { title: "Sobre m√≠", label: "sobre-mi", url: "/#sobre-mi" },
   { title: "Formaci√≥n", label: "formaci√≥n", url: "/#formacion" },
   {
      title: "Contacto",
      label: "contacto",
      url: "mailto:santiago.goncalvez.dev@gmail.com",
   },
];
---

<header
   class="fixed top-0 z-10 flex items-center justify-center w-full mx-auto mt-2"
>
   <nav
      class="flex px-2 p-1 md:gap-2 gap-1 font-medium rounded-lg text-bg-deep dark:text-title justify-center items-center"
   >
      {
         navItems.map((link) => (
            <a
               class="relative block px-2 transition rounded-lg p-1 hover:text-title hover:bg-border-strong dark:hover:bg-title dark:hover:text-bg-elevated text-xs md:text-sm"
               aria-label={link.label}
               href={link.url}
            >
               {link.title}
            </a>
         ))
      }
      <ThemeToggle />
   </nav>
</header>

<script>
   const removeAccents = (str = "") =>
      str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

   document.addEventListener("astro:page-load", () => {
      const sections = document.querySelectorAll("section[id]");
      const navLinks = document.querySelectorAll("header nav a");
      const root = document.documentElement;

      let activeItem = null;
      let pendingItem = null;
      let debounceTimer = null;

      const TOP_OFFSET = 80;
      const DEBOUNCE_DELAY = 120; // ms ‚Üí suave pero responsivo

      const isDark = () => root.classList.contains("dark");

      const applyStyles = (item) => {
         if (!item) return;

         item.classList.remove(
            "bg-title",
            "text-bg-elevated",
            "bg-bg-surface",
            "text-title",
         );

         if (isDark()) {
            item.classList.add("bg-title", "text-bg-elevated");
         } else {
            item.classList.add("bg-bg-surface", "text-title");
         }
      };

      const clearStyles = (item) => {
         item?.classList.remove(
            "bg-title",
            "text-bg-elevated",
            "bg-bg-surface",
            "text-title",
         );
      };

      const clearActiveItem = () => {
         if (activeItem) {
            clearStyles(activeItem);
            activeItem = null;
         }
      };

      // üß† Activaci√≥n con debounce visual
      const setActiveDebounced = (item) => {
         if (pendingItem === item) return;

         pendingItem = item;
         clearTimeout(debounceTimer);

         debounceTimer = setTimeout(() => {
            if (pendingItem !== activeItem) {
               clearActiveItem();
               activeItem = pendingItem;
               applyStyles(activeItem);
            }
         }, DEBOUNCE_DELAY);
      };

      // üîπ Click ‚Üí inmediato (sin debounce)
      navLinks.forEach((item) => {
         item.addEventListener("click", () => {
            clearTimeout(debounceTimer);
            pendingItem = null;
            clearActiveItem();
            activeItem = item;
            applyStyles(activeItem);
         });
      });

      // üß≠ Intersection Observer
      const observer = new IntersectionObserver(
         (entries) => {
            entries.forEach((entry) => {
               if (!entry.isIntersecting) return;

               navLinks.forEach((item) => {
                  const label = removeAccents(
                     item.getAttribute("aria-label") || "",
                  );
                  if (label === entry.target.id) {
                     setActiveDebounced(item);
                  }
               });
            });
         },
         {
            root: null,
            rootMargin: "-64px 0px -40% 0px",
            threshold: 0,
         },
      );

      sections.forEach((section) => observer.observe(section));

      // üîù Top ‚Üí nada activo (sin debounce)
      window.addEventListener(
         "scroll",
         () => {
            if (window.scrollY < TOP_OFFSET) {
               clearTimeout(debounceTimer);
               pendingItem = null;
               clearActiveItem();
            }
         },
         { passive: true },
      );

      // üåó Cambio de theme
      const themeObserver = new MutationObserver(() => {
         applyStyles(activeItem);
      });

      themeObserver.observe(root, {
         attributes: true,
         attributeFilter: ["class"],
      });
   });
</script>

<style>
   @reference "../../styles/global.css";

   nav {
      --nav-bg: rgba(255, 255, 255, 0.8);
      --nav-border: rgba(0, 0, 0, 0.08);
      --nav-shadow: rgba(0, 0, 0, 0.05);

      animation: nav-shadown 1s linear both;
      animation-timeline: scroll();
      animation-range: 0 100px;
   }

   :global(.dark) nav {
      --nav-bg: rgba(18, 18, 18, 0.8);
      --nav-border: rgba(255, 255, 255, 0.1);
      --nav-shadow: rgba(0, 0, 0, 0.5);
   }

   @keyframes nav-shadown {
      from {
         background-color: transparent;
         border: 1px solid transparent;
         box-shadow: 0 0 0 transparent;
      }
      to {
         background-color: var(--nav-bg);
         backdrop-filter: blur(12px);
         border: 1px solid var(--nav-border);
         box-shadow: 0 10px 15px -3px var(--nav-shadow);
      }
   }
</style>
