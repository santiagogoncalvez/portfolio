---
import ThemeToggle from "./ThemeToggle.astro";

const navItems = [
   { title: "Proyectos", label: "proyectos", url: "/#proyectos" },
   { title: "Sobre mí", label: "sobre-mi", url: "/#sobre-mi" },
   { title: "Formación", label: "formacion", url: "/#formacion" },
   {
      title: "Contacto",
      label: "contacto",
      url: "mailto:santiago.goncalvez.dev@gmail.com",
   },
];
---

<header class="fixed top-0 z-9 w-full mt-2 flex justify-center">
   <nav
      class="flex px-2 p-1 md:gap-2 gap-1 font-medium rounded-lg text-bg-deep dark:text-title justify-center items-center"
   >
      {
         navItems.map((link) => (
            <a
               class="relative block px-2 transition rounded-lg p-1 hover:text-title hover:bg-border-strong dark:hover:bg-title dark:hover:text-bg-elevated text-xs md:text-base"
               aria-label={link.label}
               href={link.url}
            >
               {link.title}
            </a>
         ))
      }
      <ThemeToggle />
   </nav>
</header>

<script>
   const initNavScroll = () => {
      const sections = document.querySelectorAll("section[id]");
      const navLinks = document.querySelectorAll("header nav a");
      const root = document.documentElement;

      const HEADER_OFFSET = 100;

      const removeAccents = (str: string | null) =>
         str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";

      const isDark = () => root.classList.contains("dark");

      const renderActiveState = (activeId: string) => {
         const idNormalized = removeAccents(activeId);

         navLinks.forEach((link) => {
            const linkLabel = removeAccents(link.getAttribute("aria-label"));

            // Limpiamos siempre primero
            link.classList.remove(
               "bg-title",
               "text-bg-elevated",
               "bg-bg-surface",
               "text-title",
            );

            // Si coincide, pintamos
            if (linkLabel === idNormalized) {
               if (isDark()) {
                  link.classList.add("bg-title", "text-bg-elevated");
               } else {
                  link.classList.add("bg-bg-surface", "text-title");
               }
            }
         });
      };

      const onScroll = () => {
         const scrollPosition = window.scrollY + HEADER_OFFSET;

         let currentId = "";

         if (window.scrollY < 20) {
            renderActiveState("");
            return;
         }

         sections.forEach((section) => {
            const sectionTop = (section as HTMLElement).offsetTop;
            const sectionHeight = (section as HTMLElement).offsetHeight;

            if (scrollPosition >= sectionTop) {
               currentId = section.id;
            }
         });

         if (
            window.innerHeight + window.scrollY >=
            document.body.offsetHeight - 10
         ) {
            if (sections.length > 0) {
               currentId = sections[sections.length - 1].id;
            }
         }

         renderActiveState(currentId);
      };

      let ticking = false;
      window.addEventListener(
         "scroll",
         () => {
            if (!ticking) {
               window.requestAnimationFrame(() => {
                  onScroll();
                  ticking = false;
               });
               ticking = true;
            }
         },
         { passive: true },
      );

      const themeObserver = new MutationObserver(() => {
         onScroll();
      });

      themeObserver.observe(root, {
         attributes: true,
         attributeFilter: ["class"],
      });

      onScroll();
   };

   document.addEventListener("DOMContentLoaded", initNavScroll);
   document.addEventListener("astro:after-swap", initNavScroll);
</script>

<style>
   nav {
      --nav-bg: var(--color-bg-white);
      --nav-border: var(--color-text);
      --nav-shadow: var();

      animation: nav-shadow 1s linear both;
      animation-timeline: scroll();
      animation-range: 0 100px;
   }

   html.dark nav {
      --nav-bg: var(--color-border-strong);
      --nav-border: var(--color-text-muted);
      --nav-shadow: var(--nav-shadow);
   }

   @keyframes nav-shadow {
      from {
         background-color: transparent;
         border: 1px solid transparent;
         box-shadow: 0 0 0 transparent;
      }
      to {
         background-color: var(--nav-bg);
         border: 1px solid var(--nav-border);
         box-shadow: 0 10px 15px -3px var(--nav-shadow);
      }
   }
</style>
