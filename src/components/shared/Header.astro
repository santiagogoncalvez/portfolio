---
import ThemeToggle from "./ThemeToggle.astro";

const navItems = [
   { title: "Proyectos", label: "proyectos", url: "/#proyectos" },
   { title: "Sobre mí", label: "sobre-mi", url: "/#sobre-mi" },
   { title: "Formación", label: "formacion", url: "/#formacion" },
   {
      title: "Contacto",
      label: "contacto",
      url: "mailto:santiago.goncalvez.dev@gmail.com",
   },
];
---

<header
   class="fixed top-0 z-50 w-full flex justify-center pt-3 transition-all duration-300"
>
   <nav
      id="main-nav"
      class="flex items-center gap-1 p-1.5 rounded-full transition-all duration-500 ease-in-out border border-transparent bg-transparent"
   >
      {
         navItems.map((link) => (
            <a
               class="nav-link relative block sm:px-4 py-1.5 px-2 transition-all duration-300 rounded-full 
            text-bg-deep dark:text-title
            text-xs sm:text-sm font-bold tracking-tight bg-transparent"
               aria-label={link.label}
               href={link.url}
            >
               {link.title}
            </a>
         ))
      }

      <div
         id="nav-divider"
         class="flex items-center pl-2 pr-1 border-l border-transparent transition-colors duration-500 ml-1"
      >
         <ThemeToggle />
      </div>
   </nav>
</header>

<script>
   const initNavScroll = () => {
      const nav = document.getElementById("main-nav");
      const divider = document.getElementById("nav-divider");
      const sections = document.querySelectorAll("section[id]");
      const navLinks = document.querySelectorAll(".nav-link");
      const root = document.documentElement;
      const HEADER_OFFSET = 120;

      const renderActiveState = (activeId: string) => {
         const isDark = root.classList.contains("dark");
         const idNormalized = activeId
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");

         navLinks.forEach((link) => {
            const linkLabel = link
               .getAttribute("aria-label")
               ?.normalize("NFD")
               .replace(/[\u0300-\u036f]/g, "");

            // Reset de todas las combinaciones posibles
            link.classList.remove(
               "bg-bg-base",
               "text-title",
               "bg-title",
               "text-bg-base",
               "shadow-sm",
            );
            link.classList.add(
               "bg-transparent",
               "text-bg-deep",
               "dark:text-title",
            );

            if (linkLabel === idNormalized && activeId !== "") {
               link.classList.remove(
                  "bg-transparent",
                  "text-bg-deep",
                  "dark:text-title",
               );

               if (isDark) {
                  // DARK MODE: Fondo Title (claro) y Texto Base (oscuro)
                  link.classList.add("bg-title", "text-bg-base");
               } else {
                  // LIGHT MODE: Fondo Base (claro) y Texto Title (oscuro)
                  link.classList.add("bg-bg-base", "text-title", "shadow-sm");
               }
            }
         });
      };

      const onScroll = () => {
         const scrollY = window.scrollY;
         const isDark = root.classList.contains("dark");
         let currentId = "";

         const lightBorder = "border-black/10";
         const darkBorder = "border-white/20";

         if (scrollY > 20) {
            nav?.classList.add("backdrop-blur-md", "shadow-xl");
            nav?.classList.remove("border-transparent");
            divider?.classList.remove("border-transparent");

            if (isDark) {
               nav?.classList.remove(
                  "bg-white/95",
                  "bg-transparent",
                  lightBorder,
               );
               divider?.classList.remove(lightBorder);
               nav?.classList.add("bg-[#121212]/95", darkBorder);
               divider?.classList.add(darkBorder);
            } else {
               nav?.classList.remove(
                  "bg-bg-base/90",
                  "bg-transparent",
                  darkBorder,
               );
               divider?.classList.remove(darkBorder);
               nav?.classList.add("bg-white/95", lightBorder);
               divider?.classList.add(lightBorder);
            }
         } else {
            nav?.classList.remove(
               "backdrop-blur-md",
               "shadow-xl",
               "bg-white/95",
               "bg-[#121212]/95",
               lightBorder,
               darkBorder,
            );
            divider?.classList.remove(lightBorder, darkBorder);
            nav?.classList.add("bg-transparent", "border-transparent");
            divider?.classList.add("border-transparent");
         }

         if (scrollY < 100) return renderActiveState("");

         sections.forEach((section) => {
            const sectionTop = (section as HTMLElement).offsetTop;
            if (scrollY + HEADER_OFFSET >= sectionTop) {
               currentId = section.id;
            }
         });
         renderActiveState(currentId);
      };

      window.addEventListener("scroll", onScroll, { passive: true });
      const observer = new MutationObserver(() => onScroll());
      observer.observe(root, { attributes: true, attributeFilter: ["class"] });
      onScroll();
   };

   document.addEventListener("DOMContentLoaded", initNavScroll);
   document.addEventListener("astro:after-swap", initNavScroll);
</script>
