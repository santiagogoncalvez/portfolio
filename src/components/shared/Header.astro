---
// Header.astro
import ThemeToggle from "./ThemeToggle.astro";

const navItems = [
   { title: "Proyectos", label: "proyectos", url: "/#proyectos" },
   { title: "Sobre mí", label: "sobre-mi", url: "/#sobre-mi" },
   { title: "Formación", label: "formacion", url: "/#formacion" },
   {
      title: "Contacto",
      label: "contacto",
      url: "mailto:santiago.goncalvez.dev@gmail.com",
   },
];
---

<header class="fixed top-0 z-20 w-full mt-2 flex justify-center">
   <nav
      class="flex px-2 p-1 md:gap-2 gap-1 font-medium rounded-lg text-bg-deep dark:text-title justify-center items-center"
   >
      {
         navItems.map((link) => (
            <a
               class="relative block px-2 transition rounded-lg p-1 hover:text-title hover:bg-border-strong dark:hover:bg-title dark:hover:text-bg-elevated text-xs md:text-base"
               aria-label={link.label}
               href={link.url}
            >
               {link.title}
            </a>
         ))
      }
      <ThemeToggle />
   </nav>
</header>

<!-- TODO: revisar que sucede que no se activa la detección de seccion ni la detección y seteo en el header de la sección actual -->
<script type="module">
   document.addEventListener("astro:page-load", () => {
      const removeAccents = (str) =>
         str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const sections = Array.from(document.querySelectorAll("section[id]"));
      const navLinks = Array.from(document.querySelectorAll("header nav a"));
      const root = document.documentElement;
      let activeItem = null;
      const TOP_OFFSET = 80;

      const isDark = () => root.classList.contains("dark");

      const applyStyles = (item) => {
         if (!item) return;
         navLinks.forEach((a) =>
            a.classList.remove(
               "bg-title",
               "text-bg-elevated",
               "bg-bg-surface",
               "text-title",
            ),
         );
         if (isDark()) item.classList.add("bg-title", "text-bg-elevated");
         else item.classList.add("bg-bg-surface", "text-title");
      };

      const setActiveItem = (item) => {
         if (activeItem === item) return;
         activeItem = item;
         applyStyles(item);
      };

      const updateActiveOnScroll = () => {
         const scrollPos = window.scrollY + TOP_OFFSET + 1;

         // Si estamos al inicio, no hay nada seleccionado
         if (window.scrollY < TOP_OFFSET) {
            activeItem = null;
            navLinks.forEach((a) =>
               a.classList.remove(
                  "bg-title",
                  "text-bg-elevated",
                  "bg-bg-surface",
                  "text-title",
               ),
            );
            return;
         }

         // Buscamos la sección más cercana al scroll
         let closest = sections[0];
         let minDistance = Infinity;
         for (const section of sections) {
            const distance = Math.abs(section.offsetTop - scrollPos);
            if (distance < minDistance) {
               minDistance = distance;
               closest = section;
            }
         }

         const id = removeAccents(closest.id);
         const link = navLinks.find(
            (a) => removeAccents(a.getAttribute("aria-label")) === id,
         );
         if (link) setActiveItem(link);
      };

      window.addEventListener("scroll", updateActiveOnScroll, {
         passive: true,
      });
      updateActiveOnScroll();

      // Theme observer
      const themeObserver = new MutationObserver(() => applyStyles(activeItem));
      themeObserver.observe(root, {
         attributes: true,
         attributeFilter: ["class"],
      });
   });
</script>

<style>
   nav {
      --nav-bg: var(--color-bg-white);
      --nav-border: var(--color-text);
      --nav-shadow: var();

      animation: nav-shadow 1s linear both;
      animation-timeline: scroll();
      animation-range: 0 100px;
   }

   html.dark nav {
      --nav-bg: var(--color-border-strong);
      --nav-border: var(--color-text-muted);
      --nav-shadow: var(--nav-shadow);
   }

   @keyframes nav-shadow {
      from {
         background-color: transparent;
         border: 1px solid transparent;
         box-shadow: 0 0 0 transparent;
      }
      to {
         background-color: var(--nav-bg);
         /* backdrop-filter: blur(12px); */
         border: 1px solid var(--nav-border);
         box-shadow: 0 10px 15px -3px var(--nav-shadow);
      }
   }
</style>
