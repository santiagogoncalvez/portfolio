---
import ThemeToggle from "./ThemeToggle.astro";

const navItems = [
   { title: "Proyectos", label: "proyectos", url: "/#proyectos" },
   { title: "Sobre mí", label: "sobre-mi", url: "/#sobre-mi" },
   { title: "Formación", label: "formacion", url: "/#formacion" },
   {
      title: "Contacto",
      label: "contacto",
      url: "mailto:santiago.goncalvez.dev@gmail.com",
   },
];
---

<header class="fixed top-0 z-9 w-full mt-2 flex justify-center">
   <nav
      class="flex px-2 p-1 md:gap-2 gap-1 font-medium rounded-lg text-bg-deep dark:text-title justify-center items-center"
   >
      {
         navItems.map((link) => (
            <a
               class="relative block px-2 transition rounded-lg p-1 hover:text-title hover:bg-border-strong dark:hover:bg-title dark:hover:text-bg-elevated text-xs md:text-base"
               aria-label={link.label}
               href={link.url}
            >
               {link.title}
            </a>
         ))
      }
      <ThemeToggle />
   </nav>
</header>

<script>
   const initNavScroll = () => {
      const sections = document.querySelectorAll("section[id]");
      const navLinks = document.querySelectorAll("header nav a");
      const root = document.documentElement;
      const TOP_OFFSET = 80;

      const removeAccents = (str: string | null) =>
         str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";

      const isDark = () => root.classList.contains("dark");

      const clearStyles = () => {
         navLinks.forEach((a) =>
            a.classList.remove(
               "bg-title",
               "text-bg-elevated",
               "bg-bg-surface",
               "text-title",
            ),
         );
      };

      const applyStyles = (link: Element | null) => {
         if (!link) return;
         clearStyles();
         if (isDark()) {
            link.classList.add("bg-title", "text-bg-elevated");
         } else {
            link.classList.add("bg-bg-surface", "text-title");
         }
      };

      let activeLink: Element | null = null;

      // --- LÓGICA DE DETECCIÓN INICIAL ---
      const checkCurrentSection = () => {
         const scrollPos = window.scrollY + TOP_OFFSET + 10;
         let currentId = "";

         sections.forEach((section) => {
            const htmlSection = section as HTMLElement;
            if (scrollPos >= htmlSection.offsetTop) {
               currentId = section.id;
            }
         });

         if (currentId) {
            const idNormalized = removeAccents(currentId);
            const link = Array.from(navLinks).find(
               (a) =>
                  removeAccents(a.getAttribute("aria-label")) === idNormalized,
            );
            if (link) {
               activeLink = link;
               applyStyles(link);
            }
         }
      };
      // ------------------------------------

      const observerOptions = {
         root: null,
         rootMargin: `-${TOP_OFFSET}px 0px -70% 0px`,
         threshold: 0,
      };

      const observer = new IntersectionObserver((entries) => {
         entries.forEach((entry) => {
            if (entry.isIntersecting) {
               const id = removeAccents(entry.target.id);
               const link = Array.from(navLinks).find(
                  (a) => removeAccents(a.getAttribute("aria-label")) === id,
               );

               if (link) {
                  activeLink = link;
                  applyStyles(link);
               }
            }
         });
      }, observerOptions);

      sections.forEach((section) => observer.observe(section));

      window.addEventListener(
         "scroll",
         () => {
            if (window.scrollY < TOP_OFFSET) {
               activeLink = null;
               clearStyles();
            }
         },
         { passive: true },
      );

      const themeObserver = new MutationObserver(() => {
         if (activeLink) applyStyles(activeLink);
      });

      themeObserver.observe(root, {
         attributes: true,
         attributeFilter: ["class"],
      });

      // Ejecutar el chequeo manual inmediatamente al iniciar
      checkCurrentSection();
   };

   if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initNavScroll);
   } else {
      initNavScroll();
   }
</script>

<style>
   nav {
      --nav-bg: var(--color-bg-white);
      --nav-border: var(--color-text);
      --nav-shadow: var();

      animation: nav-shadow 1s linear both;
      animation-timeline: scroll();
      animation-range: 0 100px;
   }

   html.dark nav {
      --nav-bg: var(--color-border-strong);
      --nav-border: var(--color-text-muted);
      --nav-shadow: var(--nav-shadow);
   }

   @keyframes nav-shadow {
      from {
         background-color: transparent;
         border: 1px solid transparent;
         box-shadow: 0 0 0 transparent;
      }
      to {
         background-color: var(--nav-bg);
         border: 1px solid var(--nav-border);
         box-shadow: 0 10px 15px -3px var(--nav-shadow);
      }
   }
</style>
